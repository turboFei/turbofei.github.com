I"Ê
<p>ç›®å½•</p>
<ul id="markdown-toc">
  <li><a href="#background" id="markdown-toc-background">Background</a></li>
  <li><a href="#what-is-external-shuffle-service" id="markdown-toc-what-is-external-shuffle-service">What is external shuffle service?</a></li>
  <li><a href="#why-need-external-shuffle-service" id="markdown-toc-why-need-external-shuffle-service">Why need external shuffle service?</a></li>
  <li><a href="#how-it-works" id="markdown-toc-how-it-works">How it worksï¼Ÿ</a></li>
  <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
</ul>
<h3 id="background">Background</h3>
<p>External shuffle service(ESS)æ˜¯ç‹¬ç«‹è¿è¡Œä¸€ä¸ªå¤–éƒ¨shuffleæœåŠ¡ï¼Œç”¨äºç®¡ç†sparkçš„shuffleæ•°æ®ï¼Œæœ¬æ–‡è®²è§£ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ESSï¼Œä»¥åŠéœ€è¦æ³¨æ„çš„åœ°æ–¹.æ­¤å¤„ç‰¹æŒ‡yarnShuffleService.</p>

<h2 id="what-is-external-shuffle-service">What is external shuffle service?</h2>

<p>é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å¤–éƒ¨shuffleæœåŠ¡ã€‚</p>

<p>åœ¨å·¥ä½œä¹‹å‰ï¼Œæˆ‘æ²¡æœ‰ä½¿ç”¨è¿‡spark on yarnï¼Œéƒ½æ˜¯åœ¨standaloneæ¨¡å¼ä¸‹è·‘å®éªŒã€‚æ‰€ä»¥ä¹‹å‰æ²¡æœ‰æ³¨æ„åˆ°External shuffle serviceã€‚</p>

<p>é‚£é¦–å…ˆèŠä¸€ä¸‹shuffle serviceã€‚ shuffleåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œshuffle writeå’Œshuffle readï¼Œåœ¨writeç«¯ï¼Œå¯¹æ¯ä¸ªtaskçš„æ•°æ®ï¼ŒæŒ‰ç…§keyå€¼è¿›è¡Œhashï¼Œå¾—åˆ°æ–°çš„partitionIdï¼Œç„¶åå°†è¿™äº›æ•°æ®å†™åˆ°ä¸€ä¸ªpartitionFileé‡Œé¢ï¼Œåœ¨paritionFileé‡Œé¢çš„æ•°æ®æ˜¯partitionIdæœ‰åºçš„ï¼Œå¤–åŠ ä¼šç”Ÿæˆä¸€ä¸ªç´¢å¼•ï¼Œç´¢å¼•æ¯ä¸ªpartitionFileå¯¹åº”åç§»é‡å’Œé•¿åº¦ã€‚</p>

<p>è€Œshuffle read ç«¯å°±æ˜¯ä»è¿™äº›partitionFileé‡Œé¢æ‹‰å–ç›¸åº”partitionIdçš„æ•°æ®ï¼Œæ³¨æ„æ˜¯æ‹‰å–æ‰€æœ‰partitionFileçš„ç›¸åº”éƒ¨åˆ†ã€‚</p>

<p>External shuffle Serviceå°±æ˜¯ç®¡ç†è¿™äº›shuffle writeç«¯ç”Ÿæˆçš„shuffleæ•°æ®ï¼ŒESSæ˜¯å’Œyarnä¸€èµ·ä½¿ç”¨çš„ï¼Œ åœ¨yarné›†ç¾¤ä¸Šçš„æ¯ä¸€ä¸ªnodemanagerä¸Šé¢éƒ½è¿è¡Œä¸€ä¸ªESSï¼Œæ˜¯ä¸€ä¸ªå¸¸é©»è¿›ç¨‹ã€‚ä¸€ä¸ªESSç®¡ç†æ¯ä¸ªnodemanagerä¸Šçš„executorç”Ÿæˆçš„shuffleæ•°æ®ã€‚</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cm">/** Registers a new Executor with all the configuration we need to find its shuffle files. */</span>
  <span class="n">public</span> <span class="n">void</span> <span class="nf">registerExecutor</span><span class="o">(</span>
      <span class="nc">String</span> <span class="n">appId</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">execId</span><span class="o">,</span>
      <span class="nc">ExecutorShuffleInfo</span> <span class="n">executorInfo</span><span class="o">)</span>
</code></pre></div></div>

<p>åœ¨æ³¨å†Œexecutoræ—¶ï¼Œä½¿ç”¨appId, execIdå’ŒExecutorShuffleInfo(localDirs, shuffleManagerç±»å‹).æ‰€ä»¥è¯´ESSç»´æŠ¤çš„æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œè¿™äº›shuffleæ•°æ®ä¼šåœ¨applicationè¿è¡Œç»“æŸä¹‹åï¼Œæ¸…é™¤è¿™äº›localDirsæ¥åˆ é™¤ã€‚</p>

<p>é’ˆå¯¹æ¯ä¸ªAppï¼Œ éƒ½ä¼šæœ‰ä¸€ä¸ªLoadingCacheæ¥ä¿å­˜Shuffle çš„IndexFileï¼Œé»˜è®¤æ˜¯100m, ç”±<code class="language-plaintext highlighter-rouge">spark.shuffle.service.index.cache.size</code>æ§åˆ¶ã€‚å› æ­¤è¿™ä¸ªå‚æ•°ä¸èƒ½è®¾ç½®å¤ªå¤§ï¼Œ å¦‚æœå¤ªå¤§ï¼Œåœ¨nodemanagerä¸Šæœ‰å¤šä¸ªåº”ç”¨è¿è¡Œï¼ŒåŠ¿å¿…é€ æˆESSçš„å‹åŠ›ã€‚</p>

<h2 id="why-need-external-shuffle-service">Why need external shuffle service?</h2>

<p>Sparkç³»ç»Ÿåœ¨è¿è¡Œå«shuffleè¿‡ç¨‹çš„åº”ç”¨æ—¶ï¼ŒExecutorè¿›ç¨‹é™¤äº†è¿è¡Œtaskï¼Œè¿˜è¦è´Ÿè´£å†™shuffle æ•°æ®ï¼Œç»™å…¶ä»–Executoræä¾›shuffleæ•°æ®ã€‚å½“Executorè¿›ç¨‹ä»»åŠ¡è¿‡é‡ï¼Œå¯¼è‡´GCè€Œä¸èƒ½ä¸ºå…¶ä»–Executoræä¾›shuffleæ•°æ®æ—¶ï¼Œä¼šå½±å“ä»»åŠ¡è¿è¡Œã€‚åŒæ—¶ï¼ŒESSçš„å­˜åœ¨ä¹Ÿä½¿å¾—ï¼Œå³ä½¿executoræŒ‚æ‰æˆ–è€…å›æ”¶ï¼Œéƒ½ä¸å½±å“å…¶shuffleæ•°æ®ï¼Œå› æ­¤åªæœ‰åœ¨ESSå¼€å¯æƒ…å†µä¸‹æ‰èƒ½å¼€å¯åŠ¨æ€è°ƒæ•´executoræ•°ç›®ã€‚</p>

<p>å› æ­¤ï¼Œsparkæä¾›äº†external shuffle serviceè¿™ä¸ªæ¥å£ï¼Œå¸¸è§çš„å°±æ˜¯spark on yarnä¸­çš„ï¼ŒYarnShuffleServiceã€‚è¿™æ ·ï¼Œåœ¨yarnçš„nodemanagerä¸­ä¼šå¸¸é©»ä¸€ä¸ªexternalShuffleServiceæœåŠ¡è¿›ç¨‹æ¥ä¸ºæ‰€æœ‰çš„executoræœåŠ¡ï¼Œé»˜è®¤ä¸º7337ç«¯å£ã€‚</p>

<p>å…¶å®åœ¨sparkä¸­shuffleClientæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯blockTransferServiceï¼Œå¦ä¸€ç§æ˜¯externalShuffleClientã€‚å¦‚æœåœ¨ESSå¼€å¯ï¼Œé‚£ä¹ˆexternalShuffleClientç”¨æ¥fetch  shuffleæ•°æ®ï¼Œè€ŒblockTransferServiceç”¨äºè·å–broadCastç­‰å…¶ä»–BlockManagerä¿å­˜çš„æ•°æ®ã€‚</p>

<p>å¦‚æœESSæ²¡æœ‰å¼€å¯ï¼Œé‚£ä¹ˆsparkå°±åªèƒ½ä½¿ç”¨è‡ªå·±çš„blockTransferServiceæ¥æ‹‰å–æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬shuffleæ•°æ®ä»¥åŠbroadcastæ•°æ®ã€‚</p>

<h2 id="how-it-works">How it worksï¼Ÿ</h2>

<p>ä¸å¤–éƒ¨shuffle serviceå¯¹åº”çš„å‚æ•°æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚</p>

<table>
  <thead>
    <tr>
      <th><code class="language-plaintext highlighter-rouge">spark.shuffle.service.enabled</code></th>
      <th>false</th>
      <th>Enables the external shuffle service. This service preserves the shuffle files written by executors so the executors can be safely removed. This must be enabled if <code class="language-plaintext highlighter-rouge">spark.dynamicAllocation.enabled</code> is â€œtrueâ€. The external shuffle service must be set up in order to enable it. See<a href="http://spark.apache.org/docs/latest/job-scheduling.html#configuration-and-setup">dynamic allocation configuration and setup documentation</a> for more information.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">spark.shuffle.service.port</code></td>
      <td>7337</td>
      <td>Port on which the external shuffle service will run.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">spark.shuffle.registration.timeout</code></td>
      <td>5000</td>
      <td>Timeout in milliseconds for registration to the external shuffle service.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">spark.shuffle.registration.maxAttempts</code></td>
      <td>3</td>
      <td>When we fail to register to the external shuffle service, we will retry for maxAttempts times.</td>
    </tr>
  </tbody>
</table>

<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰“å¼€å¤–éƒ¨æœåŠ¡ï¼Œè¿™é‡Œçœ‹åˆ°æè¿°é‡Œé¢å†™å½“æ‰“å¼€åŠ¨æ€åˆ†é…æ—¶ï¼Œå¿…é¡»è®¾ç½®ä¸ºtrueï¼Œæ˜¯ä¸ºäº†è®©å¤–éƒ¨shuffle serviceç®¡ç†shuffle output filesï¼Œæ–¹ä¾¿é‡Šæ”¾é—²ç½®çš„executorã€‚</p>

<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¾ç½®shuffle æœåŠ¡çš„ç«¯å£ã€‚</p>

<p>åé¢ä¸¤ä¸ªå‚æ•°ï¼Œå°±æ˜¯æ³¨å†Œè¶…æ—¶æ—¶é•¿ä¸é‡è¯•æ¬¡æ•°ï¼Œåœ¨ shuffleéœ€è¦ä¼ è¾“å¤§é‡æ•°æ®æ—¶ï¼Œshuffle serviceæ¯”è¾ƒç¹å¿™ï¼Œå›å¤è¿™äº›æ³¨å†Œä¿¡æ¯çš„æ—¶å»¶è¾ƒé«˜ï¼Œå› æ­¤å¯èƒ½ä¼šå‘ç”Ÿæ³¨å†Œå¤±è´¥é”™è¯¯ï¼Œæ­¤æ—¶è¦å°†è¿™ä¸¤ä¸ªå‚æ•°è°ƒå¤§ã€‚</p>

<p>åœ¨spark on yarnä¸­ï¼Œä¼šè®¾ç½®ä»¥ä¸‹å‚æ•°ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;property&gt;

&lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;

&lt;value&gt;spark_shuffle&lt;/value&gt;

&lt;/property&gt;

&lt;property&gt;

&lt;name&gt;yarn.nodemanager.aux-services.spark_shuffle.class&lt;/name&gt;

&lt;value&gt;org.apache.spark.network.yarn.YarnShuffleService&lt;/value&gt;

&lt;/property&gt;

&lt;property&gt;

&lt;name&gt;spark.shuffle.service.port&lt;/name&gt;

&lt;value&gt;7337&lt;/value&gt;

&lt;/property&gt;

</code></pre></div></div>

<h2 id="reference">Reference</h2>

<p><a href="http://spark.apache.org/docs/latest/configuration.html">Spark Configuration</a></p>

<p><a href="https://jaceklaskowski.gitbooks.io/mastering-apache-spark/spark-ExternalShuffleService.html">External Shuffle Service</a></p>

:ET