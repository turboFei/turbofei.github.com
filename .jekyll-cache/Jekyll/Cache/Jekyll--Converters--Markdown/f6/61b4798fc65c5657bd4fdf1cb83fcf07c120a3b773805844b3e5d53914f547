I"$
<p>ç›®å½•</p>
<ul id="markdown-toc">
  <li><a href="#å‰è¨€" id="markdown-toc-å‰è¨€">å‰è¨€</a></li>
  <li><a href="#blacklistæœºåˆ¶" id="markdown-toc-blacklistæœºåˆ¶">BlackListæœºåˆ¶</a>    <ul>
      <li><a href="#blacklistçº§åˆ«" id="markdown-toc-blacklistçº§åˆ«">BlackListçº§åˆ«</a></li>
      <li><a href="#fetchfailure--blacklist" id="markdown-toc-fetchfailure--blacklist">FetchFailure &amp; BlackList</a></li>
      <li><a href="#yarn-node-launch-failure" id="markdown-toc-yarn-node-launch-failure">Yarn Node launch Failure</a></li>
    </ul>
  </li>
  <li><a href="#blacklist-å‚æ•°" id="markdown-toc-blacklist-å‚æ•°">BlackList å‚æ•°</a></li>
</ul>
<p>æœ¬æ–‡è®²Sparkçš„Blacklistæœºåˆ¶</p>

<h3 id="å‰è¨€">å‰è¨€</h3>

<p>Sparkæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼Œtaskä¼šåˆ†å‘åˆ°å„ä¸ªèŠ‚ç‚¹å»æ‰§è¡Œï¼Œéš¾å…ä¼šæœ‰ä¸€äº›bad node ä¼šå¯¼è‡´taskçš„å¤±è´¥ï¼Œtaskå¤±è´¥çš„æ¬¡æ•°å¤šäº†ä¼šå¯¼è‡´stageå¤±è´¥ï¼Œå¦‚æœstageè¿ç»­å¤±è´¥è¾¾åˆ°é˜ˆå€¼åˆä¼šå¯¼è‡´applicationçº§åˆ«çš„å¤±è´¥ã€‚è€Œblacklist,å³é»‘åå•æœºåˆ¶ï¼Œå°±æ˜¯ä¸ºäº†å‡å°‘è¿™äº›ç”±äºbad nodeä»è€Œå¯¼è‡´åº”ç”¨æœ€ç»ˆå¤±è´¥çš„æƒ…å†µã€‚</p>

<p>BlackListæœºåˆ¶æ˜¯ç”±PR <a href="https://issues.apache.org/jira/browse/SPARK-8425">SPARK-8425</a>æå‡ºï¼Œé‡Œé¢æœ‰è®¾è®¡æ–‡æ¡£ä»¥åŠç›¸å…³sub-task.</p>

<h3 id="blacklistæœºåˆ¶">BlackListæœºåˆ¶</h3>

<p>åœ¨sparkçš„è°ƒåº¦ä¸­ï¼Œé¦–å…ˆæ˜¯è§¦å‘jobï¼Œç„¶ååˆ’åˆ†stageè¿›è¡Œæäº¤ï¼Œè€Œåœ¨æ¯ä¸ªstageä¸­éƒ½æ˜¯ä¸€äº›äº’ç›¸ç‹¬ç«‹çš„taskã€‚å› æ­¤é’ˆå¯¹sparkçš„è°ƒåº¦æœºåˆ¶ï¼Œblackliståˆ†ä¸ºå¤šç§çº§åˆ«ã€‚</p>

<h4 id="blacklistçº§åˆ«">BlackListçº§åˆ«</h4>

<ul>
  <li>(Executor, task)çº§åˆ«
    <ul>
      <li>ä¸€ä¸ªtaskå¯ä»¥åœ¨ä¸€ä¸ªexecutorä¸Šçš„æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œå¦‚æœè¶…å‡ºæ¬¡æ•°ï¼Œè¯¥executoråŠ å…¥è¯¥taskçš„blacklist</li>
    </ul>
  </li>
  <li>ï¼ˆnode, task)çº§åˆ«
    <ul>
      <li>ä¸€ä¸ªtaskå¯ä»¥åœ¨ä¸€ä¸ªnodeä¸Šçš„æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œå¦‚æœè¶…å‡ºè¿™ä¸ªæ¬¡æ•°ï¼Œåˆ™è¯¥nodeåŠ å…¥è¯¥taskçš„blacklist</li>
    </ul>
  </li>
  <li>(executor, stage)çº§åˆ«
    <ul>
      <li>åœ¨ä¸€ä¸ªstageä¸­ï¼Œå¦‚æœå…¶ä¸­çš„tasksåœ¨ä¸€ä¸ªexecutoré‡Œå¤±è´¥æ¬¡æ•°è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™åŠ å…¥è¯¥stageçš„blacklist</li>
    </ul>
  </li>
  <li>(node, stage)çº§åˆ«
    <ul>
      <li>åœ¨ä¸€ä¸ªstageä¸­ï¼Œå¦‚æœå…¶ä¸­tasksåœ¨ä¸€ä¸ªnodeä¸Šå¤±è´¥æ¬¡æ•°è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™åŠ å…¥è¯¥stageçš„blacklist</li>
    </ul>
  </li>
  <li>(Executor, application)çº§åˆ«
    <ul>
      <li>åœ¨ä¸€ä¸ªåº”ç”¨ä¸­ï¼Œå¦‚æœå…¶ä¸­tasksåœ¨ä¸€ä¸ªexecutorä¸Šå¤±è´¥æ¬¡æ•°è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™åŠ å…¥application å¯¹åº”çš„blacklist</li>
    </ul>
  </li>
  <li>(Node, application)çº§åˆ«
    <ul>
      <li>åœ¨ä¸€ä¸ªåº”ç”¨ä¸­ï¼Œå¦‚æœå…¶ä¸­tasksåœ¨ä¸€ä¸ªnodeä¸Šå¤±è´¥æ¬¡æ•°è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™åŠ å…¥applicationå¯¹åº”çš„blacklist</li>
    </ul>
  </li>
</ul>

<p>éœ€è¦æå‡ºçš„æ˜¯ï¼Œé’ˆå¯¹<strong>application</strong>çš„blacklistä¸æ˜¯æ— é™æœŸçš„ï¼Œæœ‰ä¸€ä¸ªå‚æ•°æ§åˆ¶ï¼Œ<code class="highlighter-rouge">spark.blacklist.timeout</code>,é»˜è®¤æ˜¯1hï¼Œè¶…å‡ºè¿™ä¸ªæ—¶é—´ä¹‹åä¼šä»blacklistä¸­ç§»å‡ºã€‚</p>

<p>å¯ä»¥é…ç½®æ˜¯å¦killæ‰<strong>Application BlackList</strong>çš„executorï¼Œå¦‚æœä¸€ä¸ªnodeè¢«åŠ å…¥åˆ°applicationçº§åˆ«çš„BlackListï¼Œé‚£ä¹ˆnodeä¸Šçš„æ‰€æœ‰executoréƒ½è¦killæ‰ã€‚</p>

<h4 id="fetchfailure--blacklist">FetchFailure &amp; BlackList</h4>

<p>è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯åœ¨FetchFailedé”™è¯¯çš„æ—¶å€™è¿›è¡Œçš„blacklistäº†ã€‚</p>

<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹fetch Failureã€‚</p>

<p>è¿™é‡Œçš„fetchæ˜¯æŒ‡shuffle fetchã€‚å‚ä¸çš„è§’è‰²æœ‰ä¸‰ä¸ªï¼Œæ‹‰å–æ•°æ®çš„executorï¼Œå‘é€æ•°æ®çš„executoræˆ–è€…ExternalShuffleServiceï¼Œä»¥åŠç½‘ç»œã€‚</p>

<p>å¾€å¾€æ‹‰å–æ•°æ®çš„executorä¸ä¼šæ˜¯è¿‡é”™æ–¹ï¼Œé™¤éæ˜¯è¯´å…¶åœ¨fetchçš„æ—¶å€™ä½¿ç”¨ï¼Œä¸€æ‰¹æ•°æ®çš„å¤§å°è¶…è¿‡äº†å…¶æœ€å¤§å¯æ”¾ç½®åœ¨å†…å­˜çš„é˜ˆå€¼ï¼Œéœ€è¦è¿™äº›æ•°æ®è¿›è¡Œè½ç›˜ï¼Œç„¶åä¹‹ååˆ›å»ºinputStreamçš„æ—¶å€™å‘ç”Ÿäº†IOException(å¯èƒ½æ˜¯å› ä¸ºç£ç›˜åäº†ï¼Œæˆ–è€…æ˜¯ç½‘ç»œä¼ è¾“é—®é¢˜)ï¼Œæ‰€ä»¥è¿‡é”™æ–¹æ˜¯æ‹‰å–æ•°æ®çš„executorå¯èƒ½æ€§æ¯”è¾ƒå°ã€‚</p>

<p>æ‰€ä»¥ï¼Œé—®é¢˜å°±ä¸¢ç»™äº†åŒæ–¹ä¹‹é—´çš„ç½‘ç»œä»¥åŠè¢«æ‹‰å–çš„executoræˆ–è€…ESSã€‚</p>

<p>åœ¨è¿›è¡Œshuffle fetchçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ExternalShuffleServiceï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å‘remote çš„ executorç´¢è¦æ•°æ®ï¼Œæ‰€ä»¥è¿™æ—¶å€™ä¼šå°†è¿™ä¸ªexecutor åŠ å…¥blacklistã€‚</p>

<p>è€Œå¦‚æœæ˜¯å¼€å¯äº†ESSï¼Œé‚£ä¹ˆå°±æ˜¯è¯´æˆ‘ä»¬å‘é‚£ä¸ªèŠ‚ç‚¹çš„nodemanageré‡Œé¢çš„ESSæœåŠ¡ç´¢è¦æ•°æ®å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šå°†è¿™ä¸ªESSæ‰€åœ¨çš„æ•´ä¸ªNodeåŠ å…¥åˆ°blackListã€‚</p>

<h4 id="yarn-node-launch-failure">Yarn Node launch Failure</h4>

<p>å‰é¢æåˆ°çš„éƒ½æ˜¯åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¤±è´¥ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯åœ¨yarn å¯åŠ¨containerçš„æ—¶å€™å°±å¤±è´¥å‘¢ã€‚</p>

<p><a href="https://issues.apache.org/jira/browse/SPARK-16630">SPARK-16630</a> æå‡ºäº†å°†è¿™ä¸ªä¸èƒ½æˆåŠŸå¯åŠ¨containerçš„NodeåŠ å…¥blackList.</p>

<h3 id="blacklist-å‚æ•°">BlackList å‚æ•°</h3>

<p>ä¸‹é¢æ˜¯BlackListçš„å‚æ•°ï¼Œéƒ½ä¸å‰é¢çš„ä»‹ç»å¯¹åº”ï¼Œä¸å†å†™ä¸­æ–‡ä»‹ç»ã€‚</p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°åç§°</th>
      <th>é»˜è®¤å€¼</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.enabled</code></td>
      <td>false</td>
      <td>If set to â€œtrueâ€, prevent Spark from scheduling tasks on executors that have been blacklisted due to too many task failures. The blacklisting algorithm can be further controlled by the other â€œspark.blacklistâ€ configuration options.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.timeout</code></td>
      <td>1h</td>
      <td>(Experimental) How long a node or executor is blacklisted for the entire application, before it is unconditionally removed from the blacklist to attempt running new tasks.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.task.maxTaskAttemptsPerExecutor</code></td>
      <td>1</td>
      <td>(Experimental) For a given task, how many times it can be retried on one executor before the executor is blacklisted for that task.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.task.maxTaskAttemptsPerNode</code></td>
      <td>2</td>
      <td>(Experimental) For a given task, how many times it can be retried on one node, before the entire node is blacklisted for that task.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.stage.maxFailedTasksPerExecutor</code></td>
      <td>2</td>
      <td>(Experimental) How many different tasks must fail on one executor, within one stage, before the executor is blacklisted for that stage.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.stage.maxFailedExecutorsPerNode</code></td>
      <td>2</td>
      <td>(Experimental) How many different executors are marked as blacklisted for a given stage, before the entire node is marked as failed for the stage.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.application.maxFailedTasksPerExecutor</code></td>
      <td>2</td>
      <td>(Experimental) How many different tasks must fail on one executor, in successful task sets, before the executor is blacklisted for the entire application. Blacklisted executors will be automatically added back to the pool of available resources after the timeout specified by<code class="highlighter-rouge">spark.blacklist.timeout</code>. Note that with dynamic allocation, though, the executors may get marked as idle and be reclaimed by the cluster manager.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.application.maxFailedExecutorsPerNode</code></td>
      <td>2</td>
      <td>(Experimental) How many different executors must be blacklisted for the entire application, before the node is blacklisted for the entire application. Blacklisted nodes will be automatically added back to the pool of available resources after the timeout specified by<code class="highlighter-rouge">spark.blacklist.timeout</code>. Note that with dynamic allocation, though, the executors on the node may get marked as idle and be reclaimed by the cluster manager.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.killBlacklistedExecutors</code></td>
      <td>false</td>
      <td>(Experimental) If set to â€œtrueâ€, allow Spark to automatically kill the executors when they are blacklisted on fetch failure or blacklisted for the entire application, as controlled by spark.blacklist.application.*. Note that, when an entire node is added to the blacklist, all of the executors on that node will be killed.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">spark.blacklist.application.fetchFailure.enabled</code></td>
      <td>false</td>
      <td>(Experimental) If set to â€œtrueâ€, Spark will blacklist the executor immediately when a fetch failure happens. If external shuffle service is enabled, then the whole node will be blacklisted.</td>
    </tr>
    <tr>
      <td>spark.yarn.blacklist.executor.launch.blacklisting.enabled</td>
      <td>false</td>
      <td>Flag to enable blacklisting of nodes having YARN resource allocation problems. The error limit for blacklisting can be configured by spark.blacklist.application.maxFailedExecutorsPerNode.</td>
    </tr>
  </tbody>
</table>
:ET