I"ÛP<h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>

<p>ä½œä¸ºä¸€æ¬¾æˆç†Ÿçš„å•†ä¸šè½¯ä»¶ï¼Œå®‰å…¨å¾€å¾€é²œå°‘è¢«æåŠä½†åˆä¸å¯å¿½ç•¥ï¼Œå¤§æ•°æ®è½¯ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹äºä¸€æ¬¾æˆç†Ÿçš„å¤§æ•°æ®è½¯ä»¶çš„è€ƒé‡ï¼Œä¸ä»…éœ€è¦è€ƒè™‘å…¶åŠŸèƒ½å®Œå¤‡æ€§å’Œæ€§èƒ½ï¼ŒåŒæ—¶å®‰å…¨ä¹Ÿæ˜¯ä¸å¯ç¼ºå°‘çš„ä¸€ç¯ã€‚ä¸ºä»€ä¹ˆå®‰å…¨å¦‚æ­¤é‡è¦å‘¢ï¼Ÿ</p>

<ul>
  <li>é¦–å…ˆï¼Œå•†ä¸šç¯å¢ƒé€šå¸¸æ˜¯å¤šç§Ÿæˆ·ç¯å¢ƒï¼Œä¸åŒçš„ç”¨æˆ·/ç»„å¯¹äºä¸åŒçš„æ•°æ®/åº”ç”¨æœ‰ä¸åŒçš„å®‰å…¨è€ƒé‡ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯ç›¸åº”çš„ç”¨æˆ·ä¸èƒ½åšå‡ºè¶…è¶Šæƒé™çš„æ“ä½œã€‚</li>
  <li>
    <p>åŒæ—¶ï¼Œåˆ†å¸ƒå¼æ¶æ„ä¼šå°†ç«¯å£ã€æ•°æ®æš´éœ²å‡ºå»ï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„è®¤è¯ã€åŠ å¯†æªæ–½ï¼Œè¿™ä¼šå¤§å¤§å¢åŠ äº†åŒ¿åæ”»å‡»çš„æ¦‚ç‡ã€‚</p>

    <p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ŒSparké€šè¿‡RPCé€šä¿¡åè°ƒ<code class="language-plaintext highlighter-rouge">driver</code>å’Œ<code class="language-plaintext highlighter-rouge">executor</code>ä¹‹é—´çš„ä»»åŠ¡åˆ†å‘ï¼Œå¦‚æœä¸€ä¸ªåŒ¿åç”¨æˆ·é€šè¿‡ä¼ªé€ åè®®ä¸<code class="language-plaintext highlighter-rouge">executor</code>è¿›è¡Œé€šä¿¡ï¼Œä¼šäº§ç”Ÿä»€ä¹ˆåæœå‘¢ï¼Ÿ</p>

    <p>åœ¨ä¸€ä¸ªå¯æ§çš„ç¯å¢ƒä¸‹ï¼ˆæ¯”å¦‚é˜²ç«å¢™ç‰©ç†éš”ç¦»ï¼‰è¿™æ ·çš„é£é™©ç›¸å¯¹å¯æ§ã€‚ä½†æ˜¯éšç€è¶Šæ¥è¶Šå¤šçš„äº‘è®¡ç®—å‚å•†æä¾›EMRç±»ä¼¼äº§å“ï¼Œè¿™æ ·çš„é£é™©ä¸å¯è°“ä¸å­˜åœ¨ã€‚</p>
  </li>
  <li>
    <p>å†è€…ï¼Œå¯¹äºä¸€ä¸ªå®Œæ•´çš„å¤§æ•°æ®ç”Ÿæ€ç³»ç»Ÿï¼Œå®‰å…¨å¾€å¾€æ˜¯ç›¸äº’è¡”æ¥çš„ã€‚å¦‚æœä¸­é—´æœ‰ä¸€æ¬¾è½¯ä»¶æ²¡æœ‰ç›¸åº”çš„æ”¯æŒï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæˆä¸ºæ•´ä½“çš„è–„å¼±ç‚¹ï¼Œæˆ–è€…è¯´ä¼šé€ æˆæ•´ä½“å®Œå¤‡æ€§çš„ç¼ºå¤±ã€‚</p>

    <p>æ¯”æ–¹è¯´ï¼ŒHadoopç³»ç»Ÿçš„è®¤è¯ä½“ç³»æ˜¯å»ºç«‹åœ¨KerberosåŸºç¡€ä¸Šçš„ï¼Œä¸€æ¬¾è½¯ä»¶è¦èå…¥Hadoopç”Ÿæ€ç³»ç»Ÿï¼Œå®ƒå¿…å®šä¹Ÿè¦æ”¯æŒKerberosè®¤è¯ï¼Œä¸ç„¶å®ƒæ˜¯æ— æ³•ä¸å…¶ä»–ç³»ç»Ÿè¿›è¡Œäº¤äº’çš„ã€‚</p>
  </li>
</ul>

<p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„åŸå› ï¼Œåœ¨è¿™å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚</p>

<p>å›åˆ°æˆ‘ä»¬ä»Šå¤©çš„è¯é¢˜ä¸Šæ¥ï¼ŒSparkä½œä¸ºå¤§æ•°æ®ç”Ÿæ€åœˆä¸­çš„é‡è¦ä¸€ç¯ï¼Œè®¸å¤šå‚å•†å·²ç»åœ¨å…¶ç”Ÿäº§ç¯å¢ƒä¸­å¤§é‡éƒ¨ç½²äº†Sparké›†ç¾¤ï¼ŒSparkæœ¬èº«åœ¨å®‰å…¨ä¸Šé¢æœ‰å“ªäº›ç‚¹å€¼å¾—æˆ‘ä»¬å…³æ³¨å‘¢ï¼Ÿ</p>

<h2 id="spark-security">Spark Security</h2>

<p><a href="https://spark.apache.org/docs/latest/security.html">Apache Spark</a>åœ¨å…¶æ¼”åŒ–è¿‡ç¨‹ä¸­ï¼Œå®‰å…¨çš„æ”¯æŒä¹Ÿæ˜¯é€æ¸æ·»åŠ å’Œå®Œå–„çš„ã€‚åœ¨Sparkå¼€å‘çš„æ—©æœŸï¼Œæ˜¯æ²¡æœ‰ä»»ä½•å®‰å…¨ä¸Šé¢çš„è€ƒé‡çš„ï¼Œéšç€å„å¤§å‚å•†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„éƒ¨ç½²ï¼Œå¯¹äºå®‰å…¨çš„æ”¯æŒä¹Ÿæ˜¯åœ¨é€æ­¥çš„å®Œå–„ã€‚</p>

<p>æ€»ç»“å‰é¢æåˆ°çš„ä¸‰ä¸ªæ–¹é¢ï¼Œå¯¹äºSparkæœ¬èº«ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„ä¸‰ä¸ªæ–¹é¢æ˜¯ï¼š</p>

<ol>
  <li>æƒé™ç®¡ç†</li>
  <li>æ•°æ®/é“¾è·¯åŠ å¯†</li>
  <li>ä¸å…¶ä»–å®‰å…¨ç³»ç»Ÿäº¤äº’</li>
</ol>

<p>ä¸‹æ–‡ä¼šå°±ä»¥ä¸Š3ç‚¹è¿›è¡Œè®¨è®ºï¼Œæ¥çœ‹çœ‹åœ¨Sparkä¸­å®‰å…¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>

<h3 id="æƒé™ç®¡ç†">æƒé™ç®¡ç†</h3>

<p>ä¸Šæ–‡æ‰€æåˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯<strong>ä¿è¯ç›¸åº”çš„ç”¨æˆ·ä¸èƒ½åšå‡ºè¶…è¶Šæƒé™çš„æ“ä½œ</strong>ï¼Œé‚£ä¹ˆåœ¨Sparkä¸­å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿ</p>

<h4 id="acl">ACL</h4>

<p>Sparkæ”¯æŒåŸºæœ¬çš„ACL(Access Control List)ï¼Œé€šè¿‡é…ç½®ä¸åŒç”¨æˆ·çš„è§’è‰²ï¼Œèƒ½ä¸ºä¸åŒçš„ç”¨æˆ·èµ‹äºˆä¸åŒçš„æƒé™èŒƒå›´ã€‚</p>

<p>ä¸ºäº†å¯åŠ¨ACLæœºåˆ¶ï¼Œç”¨æˆ·éœ€è¦é…ç½®<code class="language-plaintext highlighter-rouge">spark.acls.enable</code>ä¸º<code class="language-plaintext highlighter-rouge">true</code>ã€‚ç„¶åå°†ä¸åŒçš„ç”¨æˆ·åç½®äºä¸åŒçš„é…ç½®ä¸­ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">spark.ui.view.acls</code></p>

<p><code class="language-plaintext highlighter-rouge">spark.modify.acls</code></p>

<p><code class="language-plaintext highlighter-rouge">spark.admin.acls</code></p>

<p>è¿™3ä¸ªé…ç½®åˆ†åˆ«å¯¹åº”äº†å¯è¯»ã€å¯æ”¹ã€å’Œå¯ç®¡ç†ä¸‰ç§ä¸åŒçš„æƒé™ã€‚é›†ç¾¤ç®¡ç†è€…å¯å°†ç”¨æˆ·åç½®äºç›¸åº”çš„åˆ—è¡¨ä»¥èµ‹äºˆä¸åŒçš„æƒé™ã€‚</p>

<p>å¯¹äºå¤§å‹é›†ç¾¤æ¥è¯´ï¼ŒæŒ‰ç”¨æˆ·æ¥é…ç½®è¿‡äºç¹çï¼ŒSparkä¹Ÿå¯ä»¥æ”¯æŒæŒ‰ç»„è¿›è¡Œé…ç½®ï¼Œå¦‚ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">spark.ui.view.acls.groups</code></p>

<p><code class="language-plaintext highlighter-rouge">spark.modify.acls.groups</code></p>

<p><code class="language-plaintext highlighter-rouge">spark.admin.acls.groups</code></p>

<p>é‚£ä¹ˆè¿›è¡Œäº†ä¸Šè¿°è¿™äº›é…ç½®ä»¥åä¼šå¸¦æ¥ä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿ</p>

<ul>
  <li>é¦–å…ˆï¼Œåªæœ‰å…·æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·æ‰èƒ½åœ¨UIä¸Šæµè§ˆæ¯ä¸ªSparkåº”ç”¨çš„å…·ä½“å†…å®¹ï¼ŒåŒ…æ‹¬é…ç½®ã€ä½œä¸šã€ä»»åŠ¡ç­‰ç­‰ã€‚</li>
  <li>å…¶æ¬¡ï¼Œåªè¦å…·æœ‰å¯æ”¹æƒé™çš„ç”¨æˆ·æ‰èƒ½åœ¨UIä¸Šåœæ­¢ä½œä¸šã€‚</li>
  <li>æœ€åï¼Œé»˜è®¤å½“å‰sparkåº”ç”¨å¯åŠ¨ç”¨æˆ·å…·æœ‰å¯è¯»å’Œå¯æ”¹çš„æƒé™ã€‚</li>
</ul>

<p>å½“å‰Sparkçš„ACLä¸»è¦ç”¨äºUIæƒé™çš„ç®¡ç†ï¼Œä»¥ä¿è¯ç”¨æˆ·åªèƒ½æµè§ˆç›¸åº”æƒé™çš„å†…å®¹ã€‚å¯¹äºHistoryServerï¼Œåˆ™æœ‰å¦ä¸€å¥—ç±»ä¼¼çš„é…ç½®ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">spark.history.ui.acls.enable</code>ï¼Œ<code class="language-plaintext highlighter-rouge">spark.history.ui.admin.acls</code>ï¼Œåœ¨è¿™å°±ä¸å…·ä½“å±•å¼€äº†ã€‚</p>

<h4 id="spnego-authentication">Spnego Authentication</h4>

<p>å¼€å¯äº†ACLå°±èƒ½å¯¹UIè¿›è¡Œæƒé™éš”ç¦»äº†å—ï¼Ÿå…¶å®æˆ‘ä»¬è¿˜åªèµ°äº†ä¸€åŠè·¯ã€‚ä¸ºäº†ä½¿web serverï¼ˆSparkå†…åµŒJettyï¼‰èƒ½å¤Ÿå¯¹ç”¨æˆ·è¿›è¡Œéš”ç¦»ï¼Œé¦–å…ˆJettyéœ€è¦çŸ¥é“æ˜¯è°å‘èµ·äº†HTTPè¯·æ±‚ï¼Œæ¢å¥è¯è¯´ï¼Œåªæœ‰ç”¨æˆ·çš„HTTPè¯·æ±‚ä¸­åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ï¼ŒUIå’ŒACLæ‰èƒ½æ ¹æ®ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæ­£ç¡®çš„éš”ç¦»ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œæ™®é€šçš„HTTPè¯·æ±‚æ˜¯ä¸åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€‚</p>

<p>ä¸ºæ­¤éœ€è¦ä¸ºJetty servletåŠ å…¥authentication filterä»¥è·å–è®¤è¯ç”¨æˆ·çš„ä¿¡æ¯ã€‚åœ¨è¿™ä¹‹ä¸­ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯<a href="https://en.wikipedia.org/wiki/SPNEGO">Spnego authentication</a>.</p>

<p>Spnegoæ˜¯ä¸€å¥—ä»¥Kerberosä¸ºåŸºç¡€çš„HTTPè®¤è¯æœºåˆ¶ï¼Œåªæœ‰ç»è¿‡Kerberosæˆæƒçš„HTTPè¯·æ±‚æ‰èƒ½è¢«web serveræ‰€æ¥å—ã€‚Hadoopç”Ÿæ€ç³»ç»Ÿä¸‹çš„å„ä¸ªç»„ä»¶çš„UIå¤§éƒ½é‡‡ç”¨Spnegoä½œä¸ºè®¤è¯æœºåˆ¶ï¼Œå¦‚HDFSï¼ŒYARNç­‰ã€‚</p>

<p>ä¸ºäº†ä½¿Spark UIèƒ½å¤Ÿä½¿ç”¨Spnegoè®¤è¯ï¼Œç”¨æˆ·éœ€è¦å®ç°ç›¸åº”çš„authentication filterå¹¶å°†å…¶æ·»åŠ åˆ°Jettyä¸­ã€‚å¹¸è¿çš„æ˜¯Hadoopå·²ç»å¸®æˆ‘ä»¬å®ç°äº†ç›¸åº”çš„filterï¼Œåªéœ€å°†å…¶é…ç½®å°±å¯ä½¿ç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spark.ui.filters=org.apache.hadoop.security.authentication.server.AuthenticationFilter

spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.params=type=kerberos,kerberos.pricipal=&lt;kerberos-principal&gt;,kerberos.keytab=&lt;kerberos-keytab&gt;
</code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œéœ€è¦ä¸ºSpark UIåˆ›å»ºKerberos principalå’Œkeytabã€‚è¿™æ ·Spark UIå°±æœ‰äº†Spnego authenticationçš„èƒ½åŠ›äº†ï¼Œä»»ä½•ç”¨æˆ·åœ¨å‘èµ·HTTPè¯·æ±‚ä¹‹å‰å¿…é¡»å…ˆè·å¾—Kerberos tgtã€‚ä½¿ç”¨curlçš„è¯ï¼Œå¦‚ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>kinit
<span class="nv">$ </span>curl <span class="nt">--negotiate</span> <span class="nt">-u</span> : &lt;host&gt;:&lt;port&gt;/&lt;xxx&gt;

</code></pre></div></div>

<p>ç»è¿‡Spnegoè®¤è¯çš„HTTPè¯·æ±‚åœ¨å…¶HTTPå¤´éƒ¨åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ŒSpark UIå’ŒACLæœºåˆ¶ä¼šä»å…¶ä¸­è·å–ç”¨æˆ·åå¹¶åœ¨ç›¸åº”çš„æƒé™åˆ—è¡¨ä¸­è¿›è¡Œæ¯”å¯¹ã€‚</p>

<h4 id="ldap-and-others">LDAP and Others</h4>

<p>å½“ç„¶ï¼ŒSpengoè®¤è¯åªæ˜¯ä¼—å¤šauthenticationä¸­çš„ä¸€ç§ï¼Œå…¶ä»–è¿˜æœ‰å¦‚<a href="https://www.ldap.com/getting-started-with-ldap">LDAP</a>æˆ–æ˜¯basic authenticationç­‰ç­‰ã€‚å…¶ä¸­LDAPå·²ç»åœ¨<a href="https://issues.apache.org/jira/browse/HADOOP-12082">Hadoop 2.8</a>ä¸­å®ç°äº†ï¼Œç”¨æˆ·å¯ä»¥é‡‡ç”¨ä»¥ä¸Šç±»ä¼¼çš„é…ç½®å®ç°LDAPè®¤è¯ã€‚</p>

<p>åŒæ ·ï¼Œç”¨æˆ·å¯ä»¥æ˜¯å®ç°å¹¶é…ç½®è‡ªå·±çš„authentication filterï¼Œåªè¦ä¾ç…§servletå’ŒJettyçš„è§„èŒƒå³å¯ã€‚</p>

<h3 id="æ•°æ®é“¾è·¯åŠ å¯†">æ•°æ®/é“¾è·¯åŠ å¯†</h3>

<p>æ•°æ®/é“¾è·¯åŠ å¯†æ˜¯Sparkå®‰å…¨ä¸­æœ€ä¸ºé‡è¦çš„ä¸€å—ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢åŒ¿åç”¨æˆ·é€šè¿‡ç«¯å£è·å–æŠ¥æ–‡ï¼Œå‘é€maliciousæ•°æ®ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦é˜²æ­¢ç”¨æˆ·ä¼ªé€ spilledæ•°æ®ï¼ˆå¦‚shuffleæ•°æ®ï¼‰ä»¥ç ´åè¿è¡Œä½œä¸šã€‚ä¸‹æ–‡å°±å°†æ•°æ®å’Œé“¾è·¯åŠ å¯†åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚</p>

<h4 id="æ•°æ®åŠ å¯†">æ•°æ®åŠ å¯†</h4>

<p>åœ¨Sparkä¸­ï¼Œå¾€local diskä¸Šå†™çš„æ•°æ®ä¸»è¦åŒ…å«ï¼š</p>

<ol>
  <li>Shuffleæ•°æ®ï¼ŒåŒ…æ‹¬shuffle dataå’Œshuffle index fileã€‚</li>
  <li>Shuffle spillæ•°æ®ï¼Œå½“å†…å­˜æ— æ³•å®¹çº³æ—¶å‘disk spillçš„æ•°æ®ã€‚</li>
  <li>BlockManagerå­˜å‚¨åœ¨diskçš„blockæ•°æ®ã€‚</li>
  <li>ç­‰ç­‰ã€‚ã€‚ã€‚</li>
</ol>

<p>æ‰€æœ‰è¿™äº›æ•°æ®éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å°†åºåˆ—åŒ–ï¼ˆå‹ç¼©åï¼‰çš„æ•°æ®å†™å…¥åˆ°localæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚åŒ¿åç”¨æˆ·çŸ¥é“äº†Sparkä¸­shuffleæ•°æ®çš„å‘½åæ–¹å¼å’Œæ˜ å°„è§„å¾‹ï¼Œé‚£ä¹ˆä»–å°±èƒ½ä¼ªé€ ä¸€ä»½æ–°çš„shuffleæ•°æ®ã€‚ä¸ºäº†é˜²æ­¢æ­¤ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦å¯¹å†™åˆ°diskä¸Šçš„æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚</p>

<p>ä¸ºæ­¤æˆ‘ä»¬éœ€è¦é…ç½®å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Default</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>spark.io.encryption.enabled</td>
      <td>false</td>
      <td>Enable IO encryption. Currently supported by all modes except Mesos. Itâ€™s recommended that RPC encryption be enabled when using this feature.</td>
    </tr>
    <tr>
      <td>spark.io.encryption.keySizeBits</td>
      <td>128</td>
      <td>IO encryption key size in bits. Supported values are 128, 192 and 256.</td>
    </tr>
    <tr>
      <td>spark.io.encryption.keygen.algorithm</td>
      <td>HmacSHA1</td>
      <td>The algorithm to use when generating the IO encryption key. The supported algorithms are described in the KeyGenerator section of the Java Cryptography Architecture Standard Algorithm Name Documentation.</td>
    </tr>
  </tbody>
</table>

<p>å½“é…ç½®äº†è¿™äº›é€‰é¡¹ä»¥åï¼Œæ‰€æœ‰å†™å…¥local diskçš„æ•°æ®éƒ½ä¼šä»¥åŠ å¯†æ–¹å¼å†™å…¥ã€‚</p>

<h4 id="é“¾è·¯åŠ å¯†">é“¾è·¯åŠ å¯†</h4>

<p>é“¾è·¯åŠ å¯†ï¼Œå°±æ˜¯æ‰€è°“çš„wire encryptionï¼Œåœ¨Sparkä¸­ä¸»è¦åŒ…å«ä¸¤ç§ç±»å‹çš„é“¾è·¯ï¼š</p>

<ol>
  <li>HTTPè¿æ¥ã€‚Sparkçš„live UIå’ŒHistory UIæä¾›äº†WEB UIä¾›ç”¨æˆ·æµè§ˆåº”ç”¨çš„å…·ä½“ç»†èŠ‚ã€‚æˆ‘ä»¬å¸Œæœ›HTTPé“¾è·¯èƒ½å¤ŸåŠ å¯†ä»¥é˜²æ­¢åŒ¿åç”¨æˆ·çš„åŠ«æŒã€‚</li>
  <li>Binaryè¿æ¥ã€‚ä¸»è¦åŒ…å«RPCé“¾è·¯ã€Shuffleé“¾è·¯å’ŒBlockä¼ è¾“ã€‚åœ¨Sparkä¸­è¿™ä¸€éƒ¨åˆ†æ˜¯ç”±Nettyå®ç°çš„ã€‚æˆ‘ä»¬å¸Œæœ›æ‰€æœ‰çš„ç«¯åˆ°ç«¯çš„ä¼ è¾“éƒ½æ˜¯å¯ä¿¡èµ–çš„ï¼Œä¸€ä¸ªä¸è¢«ä¿¡èµ–çš„é“¾æ¥æ˜¯æ— æ³•å‘é€æ•°æ®çš„ã€‚</li>
</ol>

<p>æ ¹æ®ä¸Šé¢ä¸¤ç§ç±»å‹çš„é“¾è·¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åº”è¯¥å¦‚ä½•é…ç½®Sparkä½¿é“¾è·¯èƒ½å¾—åˆ°åŠ å¯†ã€‚</p>

<h5 id="httpsssl">HTTPS/SSL</h5>

<p>åœ¨Sparkä¸­ï¼ŒåŒ…å«HTTPçš„é“¾è·¯åˆ†åˆ«æœ‰ï¼š</p>

<ul>
  <li>Live UIï¼ŒSparkåº”ç”¨çš„WEB UIã€‚</li>
  <li>History UIï¼ŒSpark history Serverçš„WEB UIã€‚</li>
  <li>Standalone UIï¼ŒSpark Standalone cluster managerä¸­masterå’Œworker nodeçš„WEB UI</li>
</ul>

<p>ä¸ºæ­¤Sparkå¯ä»¥ä»¥ç»Ÿä¸€çš„SSLé…ç½®æ¥é…ç½®æ‰€æœ‰çš„HTTPS endpointï¼Œä¹Ÿå¯ä»¥å¯¹æ¯ä¸€ä¸ªç»„ä»¶åˆ†åˆ«è¿›è¡Œé…ç½®.</p>

<p>å½“ç”¨æˆ·é…ç½®äº†<code class="language-plaintext highlighter-rouge">spark.ssl.enabled</code>ï¼Œè¿™è¡¨ç¤ºæ‰€æœ‰HTTPS endpointéƒ½å¯åŠ¨äº†SSLå¹¶ä½¿ç”¨ç›¸åŒçš„é…ç½®ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®<code class="language-plaintext highlighter-rouge">spark.ssl.ui.xxxx</code>åªå¯åŠ¨å’Œé…ç½®Live UIçš„SSLã€‚å½“å‰æ”¯æŒçš„componentåŒ…æ‹¬<code class="language-plaintext highlighter-rouge">ui</code>ï¼Œ<code class="language-plaintext highlighter-rouge">standalone</code>å’Œ<code class="language-plaintext highlighter-rouge">historyServer</code>ã€‚</p>

<p>åœ¨é…ç½®ä¹‹å‰ï¼Œç”¨æˆ·éœ€è¦ç”Ÿæˆç›¸åº”çš„keystoreå’Œtruststoreï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨Java keytoolå·¥å…·æ¥ç”Ÿæˆç›¸åº”çš„keystoreå’Œtruststoreï¼Œå…·ä½“å¯ä»¥å‚è€ƒOracleçš„<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>

<table>
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Default</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>spark.ssl.enabled</td>
      <td>false</td>
      <td>Whether to enable SSL connections on all supported protocols. When spark.ssl.enabled is configured, spark.ssl.protocol is required. All the SSL settings like spark.ssl.xxx where xxx is a particular configuration property, denote the global configuration for all the supported protocols. In order to override the global configuration for the particular protocol, the properties must be overwritten in the protocol-specific namespace. Use spark.ssl.YYY.XXX settings to overwrite the global configuration for particular protocol denoted by YYY. Example values for YYY include fs, ui, standalone, and historyServer. See SSL Configuration for details on hierarchical SSL configuration for services.</td>
    </tr>
    <tr>
      <td>spark.ssl.[namespace].port</td>
      <td>None</td>
      <td>The port where the SSL service will listen on. The port must be defined within a namespace configuration; see SSL Configuration for the available namespaces. When not set, the SSL port will be derived from the non-SSL port for the same service. A value of â€œ0â€ will make the service bind to an ephemeral port.</td>
    </tr>
    <tr>
      <td>spark.ssl.enabledAlgorithms</td>
      <td>Empty</td>
      <td>A comma separated list of ciphers. The specified ciphers must be supported by JVM. The reference list of protocols one can find on this page. Note: If not set, it will use the default cipher suites of JVM.</td>
    </tr>
    <tr>
      <td>spark.ssl.keyPassword</td>
      <td>None</td>
      <td>A password to the private key in key-store.</td>
    </tr>
    <tr>
      <td>spark.ssl.keyStore</td>
      <td>None</td>
      <td>A path to a key-store file. The path can be absolute or relative to the directory where the component is started in.</td>
    </tr>
    <tr>
      <td>spark.ssl.keyStorePassword</td>
      <td>None</td>
      <td>A password to the key-store.</td>
    </tr>
    <tr>
      <td>spark.ssl.keyStoreType</td>
      <td>JKS</td>
      <td>The type of the key-store.</td>
    </tr>
    <tr>
      <td>spark.ssl.protocol</td>
      <td>None</td>
      <td>A protocol name. The protocol must be supported by JVM. The reference list of protocols one can find on this page.</td>
    </tr>
    <tr>
      <td>spark.ssl.needClientAuth</td>
      <td>false</td>
      <td>Set true if SSL needs client authentication.</td>
    </tr>
    <tr>
      <td>spark.ssl.trustStore</td>
      <td>None</td>
      <td>A path to a trust-store file. The path can be absolute or relative to the directory where the component is started in.</td>
    </tr>
    <tr>
      <td>spark.ssl.trustStorePassword</td>
      <td>None</td>
      <td>A password to the trust-store.</td>
    </tr>
    <tr>
      <td>spark.ssl.trustStoreType</td>
      <td>JKS</td>
      <td>The type of the trust-store.</td>
    </tr>
  </tbody>
</table>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>

<ul>
  <li>keystoreå’Œtruststoreæ˜¯ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ï¼Œè¿™æ„å‘³ç€å½“ä½ éœ€è¦ä¸ºstandalone cluster managerå¯åŠ¨SSLæ—¶ï¼Œéœ€è¦åœ¨æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šç”Ÿæˆå’Œä¿å­˜ç›¸åº”çš„keystoreï¼Œtruststoreã€‚</li>
  <li>å½“å‰YARNå¹¶ä¸æ”¯æŒproxy HTTPS requestï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨YARNçš„æ—¶å€™enable SSLä¼šå¸¦æ¥ä¸€å®šçš„é—®é¢˜ã€‚</li>
  <li>å½“ä½ åœ¨éœ€è¦mutual authenticationçš„æ—¶å€™æ‰éœ€è¦enable <code class="language-plaintext highlighter-rouge">spark.ssl.needClientAuth</code>ã€‚</li>
</ul>

<h5 id="sasl">SASL</h5>

<p>è¯´å®Œäº†HTTPS/SSLä¹‹åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦ä¸€ç§ç±»å‹çš„é“¾è·¯ï¼ŒNettyè¿æ¥ã€‚åœ¨Sparkä¸­Nettyè¿æ¥ä¹Ÿå¯ä»¥è¿›è¡Œ<a href="https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer">SASLè®¤è¯</a>ã€‚ç”¨æˆ·åªéœ€è¦è¿›è¡Œå¦‚ä¸‹çš„é…ç½®ï¼Œæ‰€æœ‰çš„Nettyé“¾è·¯ï¼ŒåŒ…æ‹¬RPCå’ŒBlock transferï¼Œéƒ½ä¼šè¿›è¡Œè®¤è¯ã€‚</p>

<table>
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Default</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>spark.authenticate</td>
      <td>false</td>
      <td>Whether Spark authenticates its internal connections. See spark.authenticate.secret if not running on YARN.</td>
    </tr>
    <tr>
      <td>spark.authenticate.secret</td>
      <td>None</td>
      <td>Set the secret key used for Spark to authenticate between components. This needs to be set if not running on YARN and authentication is enabled.</td>
    </tr>
    <tr>
      <td>spark.authenticate.enableSaslEncryption</td>
      <td>false</td>
      <td>Enable encrypted communication when authentication is enabled. This is supported by the block transfer service and the RPC endpoints.</td>
    </tr>
    <tr>
      <td>spark.network.sasl.serverAlwaysEncrypt</td>
      <td>false</td>
      <td>Disable unencrypted connections for services that support SASL authentication.</td>
    </tr>
  </tbody>
</table>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç”¨æˆ·ä½¿ç”¨çš„ä¸æ˜¯YARN cluster managerè¿è¡ŒSparkåº”ç”¨ï¼Œç”¨æˆ·éœ€è¦é…ç½®<code class="language-plaintext highlighter-rouge">spark.authenticate.secret</code>ã€‚</p>

<p>å¦å¤–ï¼Œå½“å‰Spark SASLæ‰€ä½¿ç”¨çš„è®¤è¯æ–¹å¼æ˜¯<a href="https://en.wikipedia.org/wiki/Digest_access_authentication">DIGEST-MD5</a>ï¼Œå®ƒæ˜¯ä¸€ç§æ¯”è¾ƒå¼±çš„è®¤è¯æ–¹å¼ï¼Œå®¹æ˜“è¢«æš´åŠ›ç ´è§£ï¼Œå› æ­¤ç°åœ¨å¹¶ä¸æ¨èä½¿ç”¨ï¼ˆ<a href="https://tools.ietf.org/html/rfc6331">Moving DIGEST-MD5 to Historic</a>ï¼‰ã€‚åœ¨Sparkä¸­æä¾›äº†å¦ä¸€ç§è¾ƒå¼ºçš„è®¤è¯æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®å¼€å¯ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Default</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>spark.network.crypto.enabled</td>
      <td>false</td>
      <td>Enable encryption using the commons-crypto library for RPC and block transfer service. Requires spark.authenticate to be enabled.</td>
    </tr>
    <tr>
      <td>spark.network.crypto.keyLength</td>
      <td>128</td>
      <td>The length in bits of the encryption key to generate. Valid values are 128, 192 and 256.</td>
    </tr>
    <tr>
      <td>spark.network.crypto.keyFactoryAlgorithm</td>
      <td>PBKDF2WithHmacSHA1</td>
      <td>The key factory algorithm to use when generating encryption keys. Should be one of the algorithms supported by the javax.crypto.SecretKeyFactory class in the JRE being used.</td>
    </tr>
    <tr>
      <td>spark.network.crypto.saslFallback</td>
      <td>true</td>
      <td>Whether to fall back to SASL authentication if authentication fails using Sparkâ€™s internal mechanism. This is useful when the application is connecting to old shuffle services that do not support the internal Spark authentication protocol. On the server side, this can be used to block older clients from authenticating against a new shuffle service.</td>
    </tr>
  </tbody>
</table>

<h3 id="ä¸å…¶ä»–å®‰å…¨ç³»ç»Ÿäº¤äº’">ä¸å…¶ä»–å®‰å…¨ç³»ç»Ÿäº¤äº’</h3>

<p>åœ¨ä¸€ä¸ªå®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé›†ç¾¤ä¸­ï¼ŒSparkå¹¶ä¸æ˜¯å”¯ä¸€çš„ç³»ç»Ÿï¼Œé€šå¸¸è¿˜éœ€è¦ä¸å…¶ä»–çš„è°ƒåº¦ã€å­˜å‚¨ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œå¦‚HDFSï¼ŒYARNç­‰ã€‚å¦‚æœå…¶ä»–çš„ç³»ç»Ÿéƒ½æ˜¯éœ€è¦å®‰å…¨è®¤è¯çš„ï¼ŒSparkä½œä¸ºå…¶ä»–ç³»ç»Ÿçš„ä½¿ç”¨æ–¹ï¼Œå¦‚ä½•è¿›è¡Œäº¤äº’å‘¢ï¼Ÿ</p>

<p>æ¯ç§ç³»ç»Ÿçš„è®¤è¯æ–¹å¼å„ä¸ç›¸åŒï¼Œæ²¡æœ‰ä¸€ä¸ªæ™®é€‚çš„æ¡†æ¶èƒ½å¤Ÿæ»¡è¶³æ‰€æœ‰çš„è®¤è¯æ–¹å¼ï¼Œåœ¨è¿™å°±ä»¥æœ€å¸¸è§çš„è®¤è¯æ–¹å¼Kerberosæ¥è§£é‡ŠSparkæ˜¯å¦‚ä½•ä¸å…¶ä»–Kerberizedç³»ç»Ÿæœºå‹äº¤äº’çš„ã€‚</p>

<p>é¦–å…ˆæ¯ä¸ªSparkåº”ç”¨çš„æäº¤è€…éƒ½éœ€è¦é€šè¿‡Kerberosçš„è®¤è¯ï¼Œè·å–Kerberosçš„TGTã€‚ä»¥HDFSä¸ºä¾‹ï¼Œå½“Sparkåº”ç”¨æ‹¿åˆ°TGTåå°±å¯ä»¥ä¸HDFSè¿›è¡Œäº¤äº’ï¼ŒHDFSåœ¨é€šè¿‡éªŒè¯åä¼šç»™äºˆSparkåº”ç”¨ä¸€ä¸ªæœ‰æ•ˆçš„Delegation Tokenæ¥ä»£è¡¨æ­¤ç”¨æˆ·ï¼Œåç»­çš„äº¤äº’éƒ½æ˜¯é‡‡ç”¨Delegation TokenéªŒè¯çš„æ–¹å¼ï¼Œè€Œæ— éœ€åœ¨è¿›è¡ŒKerberosè®¤è¯ã€‚</p>

<p>ä½†æ˜¯Delegation Tokenä¼šè¿‡æœŸï¼Œå½“å®ƒè¿‡æœŸåå°±ä¸å†èƒ½å¤Ÿä½¿ç”¨ï¼Œä¸ºæ­¤Sparkåº”ç”¨éœ€è¦é‡æ–°è·å¾—æ–°çš„Delegation Tokenï¼Œè·å–çš„æ–¹å¼ä¸ä¸Šé¢ä»‹ç»çš„ä¸€æ ·ï¼ˆé¦–å…ˆè·å¾—Kerberos TGTï¼Œé€šè¿‡Kerberos TGTè·å¾—Delegation Tokenï¼‰ã€‚å½“ç„¶TGTä¹Ÿä¼šè¿‡æœŸï¼Œè¿‡æœŸåéœ€è¦ç”¨æˆ·é‡æ–°kinitï¼Œæˆ–æ˜¯ä½¿ç”¨keytabå’Œprincipalçš„æ–¹å¼è®©åº”ç”¨è‡ªå·±å»æ›´æ–°TGTã€‚</p>

<p>å¯¹äºKerberoså’ŒDelegation Tokenï¼Œåœ¨è¿™å°±ä¸åšè¿‡å¤šçš„ä»‹ç»ã€‚å…³äºHadoop Securityçš„è®¾è®¡ï¼Œæœ‰ä¸€ä¸ªéå¸¸å¥½çš„<a href="http://www.carfield.com.hk/document/distributed/hadoop-security-design.pdf?">è®¾è®¡æ–‡æ¡£</a>ï¼Œå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿå®‰å…¨è®¾è®¡æœ‰éå¸¸å¤§çš„æŒ‡å¯¼æ„ä¹‰ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æœ¬æ–‡ä»æ€»ä½“ä¸Šä»‹ç»äº†Sparkä¸­å…³äºå®‰å…¨çš„å„ä¸ªæ–¹é¢ï¼Œä»¥åŠå¦‚ä½•å¼€å¯å’Œé…ç½®è¿™äº›å®‰å…¨æœºåˆ¶ã€‚æœ¬æ–‡å¹¶æœªä»åŸç†å’Œä»£ç ä¸Šé˜è¿°æ‰€æœ‰è¿™äº›å®‰å…¨æœºåˆ¶èƒŒåçš„åŸç†ä»¥åŠå®ç°ï¼Œå› ä¸ºå¯¹äºæ¯ä¸€ç§å®‰å…¨æœºåˆ¶éƒ½å¯ä»¥é•¿ç¯‡å¤§è®ºèµ˜è¿°å…¶ç”±æ¥ã€‚ç›¸åçš„æ˜¯ï¼Œç›¸æ¯”äºåŸç†ï¼Œæ€ä¹ˆå»ä½¿ç”¨å®ƒæ›´ä¸ºé‡è¦ï¼Œæ¯•ç«Ÿç»å¤§å¤šæ•°çš„ç”¨æˆ·/å¼€å‘è€…ä¸ä¼šæ¶‰åŠåˆ°é‡Œé¢çœŸæ­£çš„ç»†èŠ‚ã€‚</p>
:ET